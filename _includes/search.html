<script>
document.addEventListener('DOMContentLoaded', function() {
  // 获取 Quarto 搜索容器
  const searchContainer = document.getElementById('quarto-search');
  if (!searchContainer) return;

  // 清空并重建搜索UI
  searchContainer.innerHTML = `
    <div class="page-search-wrapper">
      <button class="page-search-btn" type="button" title="Search (Press / or s)">
        <i class="bi bi-search"></i>
      </button>
      <div class="page-search-overlay" style="display: none;">
        <div class="page-search-modal">
          <div class="page-search-header">
            <input type="text" class="page-search-input" placeholder="Search this page..." autofocus>
            <button class="page-search-close">&times;</button>
          </div>
          <div class="page-search-results"></div>
        </div>
      </div>
    </div>
  `;

  const btn = searchContainer.querySelector('.page-search-btn');
  const overlay = searchContainer.querySelector('.page-search-overlay');
  const modal = searchContainer.querySelector('.page-search-modal');
  const input = searchContainer.querySelector('.page-search-input');
  const results = searchContainer.querySelector('.page-search-results');
  const closeBtn = searchContainer.querySelector('.page-search-close');

  // 打开搜索
  function openSearch() {
    overlay.style.display = 'flex';
    input.focus();
    input.value = '';
    results.innerHTML = '<div class="search-hint">Type to search...</div>';
  }

  // 关闭搜索
  function closeSearch() {
    overlay.style.display = 'none';
    input.value = '';
    results.innerHTML = '';
    // 移除所有高亮
    document.querySelectorAll('.search-highlight').forEach(el => {
      el.outerHTML = el.textContent;
    });
  }

  btn.addEventListener('click', openSearch);
  closeBtn.addEventListener('click', closeSearch);
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeSearch();
  });

  // 快捷键
  document.addEventListener('keydown', (e) => {
    if ((e.key === '/' || e.key === 's') && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
      e.preventDefault();
      openSearch();
    }
    if (e.key === 'Escape') {
      closeSearch();
    }
  });

  // 搜索逻辑
  let debounceTimer;
  input.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => performSearch(input.value), 150);
  });

  function performSearch(query) {
    // 移除之前的高亮
    document.querySelectorAll('.search-highlight').forEach(el => {
      el.outerHTML = el.textContent;
    });

    if (!query) {
      results.innerHTML = '<div class="search-hint">Type to search...</div>';
      return;
    }

    const content = document.querySelector('.page__content') || document.querySelector('#quarto-content');
    if (!content) return;

    const searchResults = [];
    const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

    // 搜索标题
    content.querySelectorAll('h1, h2, h3').forEach(heading => {
      if (regex.test(heading.textContent)) {
        searchResults.push({
          type: 'heading',
          element: heading,
          text: heading.textContent,
          id: heading.id || heading.closest('[id]')?.id
        });
      }
    });

    // 搜索段落和列表
    content.querySelectorAll('p, li').forEach(el => {
      if (regex.test(el.textContent)) {
        const text = el.textContent.slice(0, 150);
        const heading = el.closest('section')?.querySelector('h1, h2') ||
                       findPreviousHeading(el);
        searchResults.push({
          type: 'text',
          element: el,
          text: text + (el.textContent.length > 150 ? '...' : ''),
          section: heading?.textContent || 'Content',
          id: heading?.id || heading?.closest('[id]')?.id
        });
      }
    });

    // 显示结果
    if (searchResults.length === 0) {
      results.innerHTML = '<div class="search-no-results">No results found</div>';
      return;
    }

    results.innerHTML = searchResults.slice(0, 20).map((r, i) => `
      <div class="search-result-item" data-index="${i}">
        <div class="search-result-section">${r.section || r.type}</div>
        <div class="search-result-text">${highlightText(r.text, query)}</div>
      </div>
    `).join('');

    // 点击结果
    results.querySelectorAll('.search-result-item').forEach((item, i) => {
      item.addEventListener('click', () => {
        const result = searchResults[i];
        closeSearch();

        // 滚动到元素
        result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // 高亮元素
        result.element.style.transition = 'background-color 0.3s';
        result.element.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
          result.element.style.backgroundColor = '';
        }, 2000);
      });
    });
  }

  function findPreviousHeading(el) {
    let sibling = el.previousElementSibling;
    while (sibling) {
      if (['H1', 'H2', 'H3'].includes(sibling.tagName)) return sibling;
      sibling = sibling.previousElementSibling;
    }
    return el.parentElement?.closest('section')?.querySelector('h1, h2, h3');
  }

  function highlightText(text, query) {
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }
});
</script>

<style>
.page-search-wrapper {
  position: relative;
}

.page-search-btn {
  background: transparent;
  border: none;
  padding: 0.5rem;
  cursor: pointer;
  color: inherit;
  font-size: 1.1rem;
}

.page-search-btn:hover {
  opacity: 0.7;
}

.page-search-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: 10vh;
  z-index: 9999;
}

.page-search-modal {
  background: white;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 70vh;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.page-search-header {
  display: flex;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid #e0e0e0;
  gap: 0.5rem;
}

.page-search-input {
  flex: 1;
  border: none;
  font-size: 1.1rem;
  padding: 0.5rem;
  outline: none;
  background: white;
  color: #333;
}

.page-search-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #666;
  padding: 0 0.5rem;
}

.page-search-close:hover {
  color: #333;
}

.page-search-results {
  max-height: calc(70vh - 80px);
  overflow-y: auto;
  padding: 0.5rem;
}

.search-hint, .search-no-results {
  padding: 1rem;
  text-align: center;
  color: #666;
}

.search-result-item {
  padding: 0.75rem 1rem;
  cursor: pointer;
  border-radius: 4px;
  margin-bottom: 0.25rem;
}

.search-result-item:hover {
  background: #f5f5f5;
}

.search-result-section {
  font-size: 0.75rem;
  color: #666;
  text-transform: uppercase;
  margin-bottom: 0.25rem;
}

.search-result-text {
  font-size: 0.95rem;
  line-height: 1.4;
}

.search-result-text mark {
  background: #fff3cd;
  padding: 0 2px;
  border-radius: 2px;
}
</style>
